<!--
 * Copyright (c) 2023 Robert Bosch Manufacturing Solutions GmbH
 *
 * See the AUTHORS file(s) distributed with this work for
 * additional information regarding authorship.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 *
 * SPDX-License-Identifier: MPL-2.0
 -->

<mat-toolbar data-test="toolbar" class="toolbar">
  <div *ngIf="isMultipleSelectionEnabled" data-test="toolbar-number-of-items" class="command-bar-number-of-items">
    {{ selection.selected.length > 0 ? selection.selected.length + ' / ' : '' }}{{ totalItems }}
  </div>

  <mat-form-field data-test="search-form-field-table" appearance="fill">
    <mat-label data-test="search-label">{{ 'search' | translate }}</mat-label>
    <input
      #searchInput
      data-test="search-input"
      matInput
      [formControl]="filterService.searchString"
      type="text"
      (keyup.enter)="triggerReloadFilter()"
      (focus)="searchFocused = true"
      (blur)="searchFocused = false"
    />
    <mat-error *ngIf="filterService.searchString.errors && filterService.searchString.errors['blankSpace']">
      {{ 'validation.blankSpace' | translate }}
    </mat-error>
    <mat-error *ngIf="filterService.searchString.errors && filterService.searchString.errors['invalidInput']">
      {{ 'validation.invalidInput' | translate }} {{ allowedCharacters }}
    </mat-error>
    <mat-error *ngIf="!filterService.stringColumns || !filterService.stringColumns.length">
      {{ 'validation.empty_string_columns_array' | translate }}
    </mat-error>
    <mat-error *ngIf="filterService.searchString.errors && filterService.searchString.errors['minCharNo']">
      {{ 'validation.min_char_no' | translate }} {{ minNumberCharacters }}
    </mat-error>
    <mat-error *ngIf="filterService.searchString.errors && filterService.searchString.errors['maxCharNo']">
      {{ 'validation.max_char_no' | translate }} {{ maxNumberCharacters }}
    </mat-error>
    <mat-hint *ngIf="!searchFocused && !!searchHint">{{ searchHint }}</mat-hint>
    <button data-test="search-button" mat-icon-button matSuffix aria-label="search" (click)="triggerReloadFilter()">
      <mat-icon data-test="search-icon" class="material-icons">search</mat-icon>
    </button>
  </mat-form-field>

  <ng-container *ngIf="hasAdvancedSearch">
    <mat-form-field data-test="form-field-select" appearance="fill">
      <mat-label data-test="select-label">{{ 'advancedSearch' | translate }}</mat-label>
      <mat-select data-test="select" [formControl]="filterService.selectedStringColumn">
        <mat-option [value]="filterService.advancedSearchAllValue">{{ 'allTextFields' | translate }}</mat-option>
        <mat-option *ngFor="let searchField of filterService.stringColumns" [value]="searchField">
          <span>{{ 'movement.v210.' + searchField + '.preferredName' | translate }}</span>
          <span class="advanced-search-option-description">{{ 'movement.v210.' + searchField + '.description' | translate }}</span>
        </mat-option>
      </mat-select>
    </mat-form-field>
  </ng-container>

  <mat-form-field data-test="form-field-select" appearance="fill">
    <mat-label data-test="select-label">{{ 'movement.v210.speedLimitWarning.preferredName' | translate }}</mat-label>
    <mat-select data-test="select" [(value)]="filterService.speedLimitWarningSelected" #speedLimitWarningSelect multiple>
      <div class="filter-options-container">
        <mat-option
          data-test="select-option"
          *ngFor="let speedLimitWarningOption of filterService.speedLimitWarningOptions"
          [value]="speedLimitWarningOption"
        >
          {{ speedLimitWarningOption }}
        </mat-option>
      </div>
      <div data-test="filter-actions-container" class="filter-actions-container">
        <button data-test="filter-cancel-button" mat-button (click)="speedLimitWarningSelect.close()">
          <span data-test="filter-cancel-text">{{ 'cancel' | translate }}</span>
        </button>

        <button
          data-test="filter-apply-button"
          mat-raised-button
          color="primary"
          class="filter-apply-btn"
          (click)="triggerReloadFilter(); speedLimitWarningSelect.close()"
        >
          <span data-test="filter-apply-text">{{ 'apply' | translate }}</span>
        </button>
      </div>
    </mat-select>
  </mat-form-field>

  <mat-form-field data-test="form-field-date-time" appearance="fill">
    <mat-label data-test="date-time-label">{{ 'movement.v210.startDate.preferredName' | translate }}</mat-label>
    <mat-date-range-input data-test="date-range-input" [rangePicker]="startDatePicker" [formGroup]="filterService.startDateGroup">
      <input data-test="start-date-input" matStartDate [placeholder]="'date.start' | translate" formControlName="start" />
      <input
        data-test="end-date-input"
        matEndDate
        [placeholder]="'date.end' | translate"
        formControlName="end"
        (dateChange)="triggerReloadFilter()"
      />
    </mat-date-range-input>
    <mat-datepicker-toggle data-test="datepicker-toggle" matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
    <mat-date-range-picker data-test="date-range-picker" #startDatePicker>
      <mat-date-range-picker-actions data-test="date-range-picker-actions">
        <button data-test="date-picker-cancel-button" mat-button matDateRangePickerCancel>{{ 'cancel' | translate }}</button>
        <button data-test="date-picker-apply-button" mat-raised-button color="primary" matDateRangePickerApply>
          {{ 'apply' | translate }}
        </button>
      </mat-date-range-picker-actions>
    </mat-date-range-picker>
  </mat-form-field>

  <mat-form-field data-test="form-field-date-time" appearance="fill">
    <mat-label data-test="date-time-label">{{ 'movement.v210.endDate.preferredName' | translate }}</mat-label>
    <mat-date-range-input data-test="date-range-input" [rangePicker]="endDatePicker" [formGroup]="filterService.endDateGroup">
      <input data-test="start-date-input" matStartDate [placeholder]="'date.start' | translate" formControlName="start" />
      <input
        data-test="end-date-input"
        matEndDate
        [placeholder]="'date.end' | translate"
        formControlName="end"
        (dateChange)="triggerReloadFilter()"
      />
    </mat-date-range-input>
    <mat-datepicker-toggle data-test="datepicker-toggle" matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
    <mat-date-range-picker data-test="date-range-picker" #endDatePicker>
      <mat-date-range-picker-actions data-test="date-range-picker-actions">
        <button data-test="date-picker-cancel-button" mat-button matDateRangePickerCancel>{{ 'cancel' | translate }}</button>
        <button data-test="date-picker-apply-button" mat-raised-button color="primary" matDateRangePickerApply>
          {{ 'apply' | translate }}
        </button>
      </mat-date-range-picker-actions>
    </mat-date-range-picker>
  </mat-form-field>

  <span data-test="spacer" class="spacer"></span>

  <button data-test="refresh-data-button-table" mat-icon-button aria-label="Refresh table" (click)="triggerReloadFilter()">
    <mat-icon data-test="refresh-data-icon" class="material-icons" [matTooltip]="'tableActions.refreshData' | translate"
      >autorenew</mat-icon
    >
  </button>

  <button data-test="export-data-button-table" mat-icon-button aria-label="Download data as CSV" (click)="triggerExportToCsv()">
    <mat-icon data-test="export-data-icon" class="material-icons" [matTooltip]="'tableActions.exportData' | translate"
      >file_download</mat-icon
    >
  </button>

  <button
    data-test="open-configuration"
    mat-icon-button
    aria-label="Open configuration"
    [matMenuTriggerFor]="configurationMenu"
    (menuOpened)="triggerInitOpenedConfigurationDialog()"
  >
    <mat-icon data-test="open-configuration-icon" class="material-icons" [matTooltip]="'tableActions.openConfig' | translate"
      >settings
    </mat-icon>
  </button>
</mat-toolbar>

<mat-menu data-test="column-menu" #configurationMenu="matMenu" class="column-menu">
  <version-support-table-config-menu
    #configurationMenuComponent
    (configChangedEvent)="triggerSetConfiguration($event)"
  ></version-support-table-config-menu>
</mat-menu>
